<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - Sistema de Estoque</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar (mesma do dashboard) -->
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-boxes"></i>
                <h2>StockFlow</h2>
            </div>
            
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <div>
                    <h3>{{ session.get('username', 'Usuário') }}</h3>
                    <p>Administrador</p>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li>
                    <a href="{{ url_for('dashboard') }}">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('estoque') }}">
                        <i class="fas fa-box-open"></i>
                        <span>Estoque</span>
                    </a>
                </li>
                <li class="active">
                    <a href="{{ url_for('relatorios') }}">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relatórios</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('register') }}">
                        <i class="fas fa-user-plus"></i>
                        <span>Novo Admin</span>
                    </a>
                </li>
            </ul>
            
            <div class="logout-btn">
                <a href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-title">
                    <h1><i class="fas fa-chart-bar"></i> Relatórios</h1>
                    <p>Análises e estatísticas do seu estoque</p>
                </div>
                <div class="header-actions">
                    <button onclick="printReport()" class="btn-primary">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button onclick="exportToPDF()" class="btn-secondary">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
            </header>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash {{ category }}">
                                <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Estatísticas Gerais -->
            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ total_produtos }}</h3>
                        <p>Produtos Cadastrados</p>
                    </div>
                </div>
                
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3>R$ {{ "%.2f"|format(valor_total_estoque) }}</h3>
                        <p>Valor Total em Estoque</p>
                    </div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ movimentacao|length }}</h3>
                        <p>Meses Analisados</p>
                    </div>
                </div>
                
                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ produtos_por_marca|length }}</h3>
                        <p>Marcas Diferentes</p>
                    </div>
                </div>
            </div>

            <!-- Gráficos de Análise -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-pie"></i> Valor por Marca</h3>
                    </div>
                    <canvas id="valorMarcaChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-exchange-alt"></i> Movimentação Mensal</h3>
                    </div>
                    <canvas id="movimentacaoMensalChart"></canvas>
                </div>
            </div>

            <!-- Tabela de Produtos por Marca -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-tags"></i> Produtos por Marca</h3>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Marca</th>
                                <th>Quantidade de Produtos</th>
                                <th>Valor Total</th>
                                <th>Valor Médio</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for marca in produtos_por_marca %}
                            <tr>
                                <td><strong>{{ marca.marca }}</strong></td>
                                <td>{{ marca.quantidade }}</td>
                                <td>R$ {{ "%.2f"|format(marca.valor_total) }}</td>
                                <td>R$ {{ "%.2f"|format(marca.valor_total / marca.quantidade) if marca.quantidade > 0 else 0 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL</strong></td>
                                <td><strong>{{ total_produtos }}</strong></td>
                                <td><strong>R$ {{ "%.2f"|format(valor_total_estoque) }}</strong></td>
                                <td><strong>R$ {{ "%.2f"|format(valor_total_estoque / total_produtos if total_produtos > 0 else 0) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Movimentação Mensal -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-calendar-alt"></i> Movimentação Mensal</h3>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Mês</th>
                                <th>Entradas</th>
                                <th>Saídas</th>
                                <th>Saldo</th>
                                <th>Taxa de Rotatividade</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in movimentacao %}
                            <tr>
                                <td>{{ mov.mes }}</td>
                                <td>{{ mov.entradas }}</td>
                                <td>{{ mov.saidas }}</td>
                                <td>{{ mov.entradas - mov.saidas }}</td>
                                <td>
                                    {% if mov.entradas > 0 %}
                                        {{ "%.1f"|format((mov.saidas / mov.entradas) * 100) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Relatórios Gerenciais -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-line"></i> Tendência de Estoque</h3>
                    </div>
                    <canvas id="tendenciaChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-balance-scale"></i> Distribuição de Valores</h3>
                    </div>
                    <canvas id="distribuicaoChart"></canvas>
                </div>
            </div>

            <!-- Insights e Recomendações -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-lightbulb"></i> Insights e Recomendações</h3>
                </div>
                <div class="insights-grid">
                    <div class="insight-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Produtos com Baixo Estoque</h4>
                        <p>Verifique os produtos com quantidade abaixo de 5 unidades para evitar ruptura de estoque.</p>
                        <a href="{{ url_for('estoque') }}?filtro_estoque=baixo" class="btn-view-all">Ver Produtos</a>
                    </div>
                    
                    <div class="insight-card">
                        <i class="fas fa-chart-line"></i>
                        <h4>Marcas com Mais Saídas</h4>
                        <p>Analise as marcas com maior rotatividade para otimizar seu mix de produtos.</p>
                        <a href="{{ url_for('estoque') }}" class="btn-view-all">Analisar</a>
                    </div>
                    
                    <div class="insight-card">
                        <i class="fas fa-calendar-check"></i>
                        <h4>Próximas Renovações</h4>
                        <p>Produtos com data de entrada superior a 6 meses podem precisar de renovação.</p>
                        <a href="{{ url_for('estoque') }}" class="btn-view-all">Verificar</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Gráfico de Valor por Marca
        const valorMarcaCtx = document.getElementById('valorMarcaChart').getContext('2d');
        const valorMarcaChart = new Chart(valorMarcaCtx, {
            type: 'bar',
            data: {
                labels: [
                    {% for marca in produtos_por_marca[:5] %}
                        '{{ marca.marca }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Valor Total (R$)',
                    data: [
                        {% for marca in produtos_por_marca[:5] %}
                            {{ marca.valor_total }},
                        {% endfor %}
                    ],
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                    ],
                    borderColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Gráfico de Movimentação Mensal
        const movimentacaoCtx = document.getElementById('movimentacaoMensalChart').getContext('2d');
        const movimentacaoChart = new Chart(movimentacaoCtx, {
            type: 'line',
            data: {
                labels: [
                    {% for mov in movimentacao|reverse %}
                        '{{ mov.mes }}',
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Entradas',
                    data: [
                        {% for mov in movimentacao|reverse %}
                            {{ mov.entradas }},
                        {% endfor %}
                    ],
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Saídas',
                    data: [
                        {% for mov in movimentacao|reverse %}
                            {{ mov.saidas }},
                        {% endfor %}
                    ],
                    borderColor: '#e74a3b',
                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Gráfico de Tendência
        const tendenciaCtx = document.getElementById('tendenciaChart').getContext('2d');
        const tendenciaChart = new Chart(tendenciaCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                datasets: [{
                    label: 'Estoque Atual',
                    data: [65, 59, 80, 81, 56, 55, 40, 50, 60, 70, 80, 90],
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });

        // Gráfico de Distribuição
        const distribuicaoCtx = document.getElementById('distribuicaoChart').getContext('2d');
        const distribuicaoChart = new Chart(distribuicaoCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Produtos',
                    data: [
                        {x: 10, y: 20},
                        {x: 20, y: 30},
                        {x: 30, y: 40},
                        {x: 40, y: 50},
                        {x: 50, y: 60}
                    ],
                    backgroundColor: '#4e73df'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tempo em Estoque (dias)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Valor (R$)'
                        }
                    }
                }
            }
        });

        // Funções de exportação
        function printReport() {
            window.print();
        }

        function exportToPDF() {
            alert('Funcionalidade de PDF em desenvolvimento. Use a opção de impressão do navegador.');
        }

        // Atualizar data atual
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('pt-BR', options);
            }
        }

        updateCurrentDate();
        setInterval(updateCurrentDate, 60000);
    </script>
</body>
</html>